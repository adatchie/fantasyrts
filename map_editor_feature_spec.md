# マップエディタ地形機能拡張 仕様書

## 1. 概要
本ドキュメントは、Fantasy RTS マップエディタに追加された「地形ブラシツール」および「プロシージャル地形生成」機能の仕様をまとめたものです。

## 2. 高さ編集ブラシ (Height Brushes)

### 2.1 機能一覧
| ツール名 | アイコン | 処理内容 | 制約 |
| :--- | :--- | :--- | :--- |
| **Raise (隆起)** | 🔼 | クリックしたセルの高さを +1 | 最大高さ: 10 |
| **Lower (沈降)** | 🔽 | クリックしたセルの高さを -1 | 最小高さ: 0 |
| **Smooth (整地)**| 〰️ | クリックしたセルとその周囲(3x3)の平均高さを適用 | 四捨五入(Round)して整数化 |

### 2.2 実装詳細
- **対象**: `map.terrain.heightMap` の直接操作（`paintCell` メソッド内）
- **プレビュー**: 操作ごとに `render()` および `update3DPreviewDebounced()` を呼び出し、2D/3D両方の表示を即時更新。
- **ドラッグ操作**: マウスドラッグによる連続適用が可能（Paintツールと同様）。

## 3. プロシージャル地形生成 (Procedural Terrain Generation)

### 3.1 機能概要
「🏔️ 自動生成」ボタンからモーダルを開き、プリセットとパラメータを選択してマップ全体の地形を一括生成する機能。

### 3.2 プリセット (Presets)
| プリセット名 | 処理ロジック | パラメータ依存 |
| :--- | :--- | :--- |
| **Flat (平坦)** | 全セルをベース高さに統一 | Base Height |
| **Slope (坂)** | 指定方向（N/S/E/W）に向かって高くなる線形勾配 | Direction, Intensity, Base Height |
| **Hill (丘)** | マップ中心を頂点とする円錐状（コサインカーブ）の盛り上がり | Intensity, Base Height |
| **Valley (谷)** | 指定軸（X/Y）を中心に低くなるV字型の地形 | Valley Axis, Intensity, Base Height |
| **Terrace (段丘)**| 斜めのグラデーションを階段状（3段階）に量子化 | Intensity, Base Height |
| **Random (ランダム)**| 各セルにランダムな高さを加算（ノイズ） | Intensity (振幅), Base Height |

### 3.3 パラメータ
- **Scale / Intensity (1-10)**: 高さの変化量や勾配の急さを制御。
- **Base Height (0-5)**: 基準となる高さ（最低面の高さ）。
- **Direction**: Slope, Valley の生成方向。
- **Keep Objects**: 既存の建物(`buildings`)やユニット(`units`)を維持するか、クリアするかのオプション。

### 3.4 実装詳細
- `executeTerrainGeneration` メソッドにて実装。
- 既存のハイトマップのコピーを作成し、計算後に一括適用。
- マップサイズ (`width`, `height`) に依存せず動的に計算。

## 4. UI/UX 仕様

### 4.1 ツールバー
- **追加ボタン**:
    - `🔼 隆起`
    - `🔽 沈降`
    - `〰️ 整地`
    - `🏔️ 自動生成` (緑色系で強調)

### 4.2 ショートカット / 操作
- **Rキー**: 建物の回転 (0, 90, 180, 270度)
- **右クリック**: コンテキストメニュー無効化（誤操作防止）

## 5. データ構造への影響
- `map.terrain.heightMap`: 2次元配列 `[y][x]` に整数値(0-10)として格納。
- 保存形式 (`.json`) への変更はなし（既存のheightMapフィールドを使用）。

## 6. 既知の制限事項 / 今後の課題
- Undo/Redo機能は未実装。
- Smoothブラシは1回のクリックで1回適用されるため、強くかけるには連打が必要。
- 生成アルゴリズムは簡易的なものであり、パーリンノイズ等の複雑な自然地形生成は含まない。
