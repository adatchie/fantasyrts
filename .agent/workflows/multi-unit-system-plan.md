---
description: 1000人単位マルチユニットシステム実装計画
---

# マルチユニットシステム実装計画

## 概要
現在の単一大ユニット制から、**兵力1000人ごとに1ユニット（1HEX）を配置する分散型システム**への変更。
例：徳川家康30000人 → 30個の独立ユニット（中央に本陣）

## 目標とする仕様

### ユニット配置
- **1000人 = 1ユニット（1HEX）**
- 中央に**本陣ユニット**が存在（特別な属性を持つ）
- 各ユニットにデフォルト1000人ずつ配分
- 端数（1000未満）は最外周のいずれかに配分

### 目標設定フェイズ
- 同武将のユニットのどれかを選択 → **武将傘下の全ユニット選択**
- 目標設定 → **全ユニットに同一目標をセット**
- 左リストには**個別兵力を表示せず、合計兵力のみ表示**

### 行動フェイズ
- **1ユニット（最大1000人）ごと**に残り兵数でターンが回る
- 各ユニットが**個別に経路決定・移動・攻撃**
- **調略のみ特例**: 1武将1ターン1回のみ（ユニット数に比例しない）

### 本陣システム
- **本陣の兵数が0になると、その武将の全ユニットが敗走（消滅）**
- 本陣を守りつつ、包囲攻撃を仕掛ける戦略性

## 実装ステップ

### Phase 1: データ構造の再設計 ✓基盤
1. **新しいユニットデータ構造**を設計
   - `warlordId`: 武将ID（どの武将に属するか）
   - `unitType`: 'HEADQUARTERS' | 'NORMAL' （本陣 or 通常）
   - `soldiers`: このユニットの兵数（最大1000）
   - `q`, `r`: HEX座標
   - その他必要な属性（目標、命令など）

2. **武将グループ管理**
   - 武将ごとに配下のユニット配列を管理
   - ユニット生成関数を作成（兵力から必要ユニット数を計算）

### Phase 2: ユニット配置ロジック
1. **初期配置アルゴリズム**
   - 武将の初期位置`(q, r)`を中心に
   - 本陣を中央に配置
   - 周囲に螺旋状または放射状にユニットを配置
   - 配置パターン関数: `generateUnitPositions(centerQ, centerR, unitCount)`

2. **兵力分配**
   - 各ユニットに1000人ずつ
   - 端数を最外周ユニットに配分

### Phase 3: UI/UX の調整
1. **選択システムの変更**
   - ユニットクリック → 同武将の全ユニット選択
   - ボックス選択の調整

2. **左リスト表示**
   - 武将単位で表示（合計兵力）
   - 個別ユニットは非表示

3. **描画の調整**
   - ユニットサイズは全て1HEX（size属性を無視または固定）
   - 本陣ユニットは視覚的に区別（特別な枠や色）

### Phase 4: 行動システムの変更
1. **ターン順序**
   - ユニット単位でソート（残り兵数順）
   - 各ユニットが個別に行動

2. **目標共有**
   - 同武将のユニットは同じ目標を共有
   - 目標設定時に武将傘下全てに適用

3. **調略の制限**
   - 武将ごとに調略フラグ（1ターン1回のみ）
   - ユニット数に関わらず制限

### Phase 5: 本陣システム
1. **本陣の特別処理**
   - 本陣ユニットの兵数が0 → 武将の全ユニット敗走
   - 敗走処理: 全ユニットを`dead`状態に

2. **本陣の視覚効果**
   - 特別な枠線やエフェクト
   - 本陣が危機的状況の警告

### Phase 6: AI調整
1. **AI の行動を個別ユニット対応**
   - 各ユニットが個別に経路を決定
   - ただし武将全体の戦略は統一

### Phase 7: テスト & バランス調整
1. **動作確認**
   - 全機能の動作テスト
   - パフォーマンステスト

2. **ゲームバランス**
   - 包囲攻撃の効果
   - 本陣リスクのバランス

## 技術的課題

### 1. パフォーマンス
- ユニット数が大幅に増加（30000人 → 30ユニット）
- 全武将で合計ユニット数が数百になる可能性
- 描画・経路探索の最適化が必要

### 2. 経路探索
- 各ユニットが個別に経路を計算
- 同じ目標でも微妙に異なる経路を取る可能性
- ユニット間の衝突・重なり処理

### 3. UI/UX
- 多数のユニットを視覚的に管理
- 選択・選抜が煩雑にならないように

## ファイル修正リスト

### 必須修正ファイル
1. **`scripts/constants.js`**
   - ユニットタイプの定数追加
   - 武将データの調整

2. **`scripts/main.js`**
   - ユニット生成ロジック
   - 選択システムの変更
   - ターン処理の変更

3. **`scripts/rendering.js`**
   - ユニット描画の調整（全て1HEX）
   - 本陣の特別描画

4. **`scripts/combat.js`**
   - ユニット単位の戦闘処理
   - 本陣敗走処理

5. **`scripts/ai.js`**
   - ユニット単位のAI判断

6. **`scripts/pathfinding.js`**
   - （必要に応じて調整）

### 新規作成ファイル
- **`scripts/unit-manager.js`** （推奨）
  - ユニット生成・管理の専用クラス
  - 武将グループ管理

## 実装優先度

**最優先**:
1. データ構造の再設計
2. ユニット生成ロジック
3. 基本的な描画

**高優先**:
4. 選択システム
5. ターン処理の変更
6. 本陣システム

**中優先**:
7. UI調整
8. AI調整

**低優先**:
9. 視覚効果
10. パフォーマンス最適化

## 次のアクション
1. ユーザーに実装計画を確認
2. Phase 1から順次実装開始
3. 各Phaseごとにテスト・確認
