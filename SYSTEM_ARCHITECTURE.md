# Sekigahara System Architecture & Reuse Guide

このドキュメントは、「関ケ原」システムのアーキテクチャ概要と、新規ゲーム（タクティクスRTS）への流用・改造手順をまとめたものです。
モデルが新しいチャットでシステムを理解するための「取扱説明書」として機能します。

## 1. システム構成 (Architecture)

### コアモジュール (`scripts/`)
| ファイル | 役割 | 流用可能性 |
| --- | --- | --- |
| `main.js` | ゲームループ、初期化、入力処理、UI連携 | **高** (構造はそのまま使える) |
| `combat.js` | 戦闘ロジック、移動フェイズ、攻撃処理、調略 | **高** (ロジックは共通。距離計算の修正が必要) |
| `unit-manager.js` | ユニット生成、武将データ管理、部隊管理 | **高** (データ構造は流用可) |
| `ai.js` | CPU思考ルーチン（フェイズ進行、陣形決定） | **中** (戦術ロジックは使えるが、地形評価関数の修正が必要) |
| `formation.js` | 陣形定義と補正値 | **中** (陣形の概念は使えるが、配置座標計算はHEX依存のため修正必須) |
| `pathfinding.js` | 経路探索 (A*) | **低** (コアアルゴリズムのみ。隣接ノード取得を6方向→4/8方向へ変更要) |
| `map.js` | マップ生成、データ保持 | **書き直し** (HEX→スクエア+高さのため) |
| `rendering3d.js` | Three.jsによる描画 | **書き直し** (地形メッシュ生成、座標変換ロジックが総入れ替え) |

### データフロー
1.  **Main Loop**: `main.js` が `requestAnimationFrame` でループを回し、UI更新を行う。
2.  **Phase System**: `ORDER` (目標設定) → `ACTION` (行動解決) のサイクル。
3.  **Unit Processing**: `combat.js` の `processUnit` が全ユニットを兵数順/イニシアチブ順に処理。
    - `Order` (命令) に基づき `Move` か `Attack` を実行。

## 2. 新規ゲームへの移行・改造手順

### Step 1: プロジェクトの複製
1.  現在のフォルダ `sekigahara4` をコピーし、 `fantasy_rts` などの名前に変更する。
2.  不要な特定アセット（`portraits/`の戦国武将画像など）を削除。

### Step 2: 座標系の変更 (HEX -> Square)
最も大きな変更点です。

*   **変更前 (Hex)**:
    *   座標: `q` (Axial), `r` (Axial)
    *   距離: `(abs(dq) + abs(dr) + abs(dq+dr)) / 2`
    *   隣接: 6方向
*   **変更後 (Square + Height)**:
    *   座標: `x`, `y`, `z` (高さ)
    *   距離: マンハッタン距離 `abs(dx) + abs(dy)` または ユークリッド距離
    *   隣接: 4方向 (上下左右)。ただし段差 `z` の差が一定以下なら移動可能。

#### 修正が必要なファイル
1.  `pathfinding.js`:
    *   `getNeighbors(node)` を6方向から4方向へ変更。
    *   `cost(a, b)` に高さによるコスト加算を追加。
2.  `combat.js`:
    *   `getDist(u1, u2)` をスクエア距離計算に変更。
    *   `getFacingAngle` (向き) を0-5(6方向)から0-3(4方向)へ変更。
    *   `combat`メソッド内の「背面・側面」判定ロジックを4方向用に修正。
3.  `formation.js`:
    *   陣形の相対座標定義をHEX用からスクエア用配列に変更。

### Step 3: レンダリングエンジンの刷新 (`rendering3d.js`)
*   `drawHexGrid` などを廃止し、`drawVoxelTerrain` (またはPlane形状) を実装。
*   ユニットの表示座標変換 (`hexToPixel`) を `gridToWorld(x,y,z)` に置き換え。

## 3. 流用できる具体的な機能
以下の機能はロジック修正ほぼなしで流用可能です。
*   **2フェイズ進行**: `main.js` の `commitTurn` -> `resolveTurn` の流れ。
*   **マルチユニット管理**: 武将ID (`warlordId`) で部隊をまとめる仕組み。
*   **UI/選択システム**: 矩形選択 (`handleBoxSelect`)、右クリックメニュー。
*   **エフェクト管理**: `combat.js` の `spawnEffect` システム。

## 4. AIへの指示出しのコツ
新しいチャットで始める際は、最初にこのファイルをアップロードし、以下のように伝えてください。
> 「この `SYSTEM_ARCHITECTURE.md` はベースとなるシステムの仕様書です。これを元に、MapシステムとRenderingシステムをスクエアグリッド（クォータービュー）用に書き換えてください。」
